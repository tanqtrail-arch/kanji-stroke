# Claude Code 開発指示文

## プロジェクト概要

TRAIL教育ゲーム「漢字の成り立ち（kanji-stroke）」を開発してください。
小学校全学年の漢字1,026字の書き順アニメーション学習アプリです。

## 必読ファイル

開発開始前に以下を必ず読み込んでください：

1. `KANJI_STROKE_GAME_SPEC.md` — ゲーム仕様書（UI設計・データ構造・画面遷移・ALT仕様すべて記載）
2. `TRAIL_GAME_SPEC.md` — TRAIL共通ルール（連携仕様・コード品質基準）

## KanjiVGについて

書き順のSVGデータは **KanjiVG** (https://github.com/KanjiVG/kanjivg) を使用します。
`kanjivg-20250816-main.zip` をプロジェクトルートに配置してあります。
ZIPの中の `kanji/` フォルダに、1文字1SVGファイルで格納されています。
ファイル名はUnicodeの16進数です（例：「日」= `065e5.svg`、「山」= `05c71.svg`）。
ライセンスは CC BY-SA 3.0 です。クレジット表記をアプリ内に入れてください。

## 開発フェーズ

### Phase 1: データ準備（まずここから）

`scripts/extract-kanjivg.py` を作成し、以下を実行：

1. 小学校配当漢字1,026字の学年別リストを定義する
   - 2020年改定の新学習指導要領に準拠すること
   - 小1: 80字 / 小2: 160字 / 小3: 200字 / 小4: 202字 / 小5: 193字 / 小6: 191字
2. `kanjivg-20250816-main.zip` 内の `kanji/` フォルダから該当SVGを読み込む
3. 各SVGから以下を抽出：
   - `<path>` の `d` 属性 → `paths[]`（配列順 = 書き順）
   - `<text>` の `transform="matrix(1 0 0 1 X Y)"` から座標 → `strokeNums[{x, y}]`
4. 学年別JSONファイルに出力：`data/kanji-grade{1-6}.json`

**JSONの1エントリ構造：**
```json
{
  "char": "日",
  "unicode": "065e5",
  "grade": 1,
  "strokeCount": 4,
  "paths": ["M31.5,24.5c1.12,...", "M33.48,26c0.8,..."],
  "strokeNums": [{"x": 25.25, "y": 32.63}],
  "readings": { "on": ["ニチ", "ジツ"], "kun": ["ひ", "か"] },
  "meaning": "太陽・日",
  "bushu": "日",
  "formation": { "type": "象形", "description": "太陽の形をかたどった" }
}
```

- `readings`, `meaning`, `bushu`, `formation` は Phase 1 では空欄でOK（段階的に埋める設計に）
- ただし `char`, `unicode`, `grade`, `strokeCount`, `paths`, `strokeNums` はPhase 1で必須

### Phase 2: コアUI（学年選択 → 漢字一覧 → 書き順）

Vanilla JS（フレームワーク不使用）でSPAを構築。

**画面：**
- ホーム画面：ゲームタイトル + 4つのモードボタン
- 学年選択画面：小1〜小6のカード（各学年の漢字数を表示）
- 漢字一覧画面：選択した学年の漢字をグリッド表示（6〜8列）、学習済みにはチェック
- 漢字詳細画面：タブ切り替え（書き順 / 成り立ち）

**書き順アニメーション仕様（プロトタイプ検証済み）：**
- SVG viewBox: `0 0 109 109`、表示サイズ: `260×260px`
- 十字ガイド線: `stroke:#E8E4DF, strokeWidth:0.3, strokeDasharray:3,3`
- ゴーストストローク: `strokeWidth:4, stroke:#EEEBE6`
- 完了ストローク: `strokeWidth:3.5, stroke:#2D2D2D`
- アクティブストローク: `strokeWidth:5, stroke:テーマカラー`
- アニメーション: `@keyframes drawStroke { to { stroke-dashoffset: 0 } }` 0.6秒
- 画間: 0.75秒
- パス長は `path.getTotalLength()` で実行時に計測
- 操作: 「▶自動再生」「次の画→」「↻リセット」
- プログレスバー: 現在画数/総画数

**データ読み込み：**
- 学年選択時にその学年のJSONを `fetch()` で遅延ロード
- 読み込み中はスケルトンUI表示
- 一度読み込んだ学年はメモリにキャッシュ

### Phase 3: クイズ機能

4種類のクイズ：
1. **読みクイズ**: 漢字 → 4択で正しい読みを選ぶ
2. **意味クイズ**: 漢字 → 4択で正しい意味を選ぶ
3. **成り立ちクイズ**: 漢字 → 象形/指事/会意/形声 の4択
4. **書き順クイズ**: 「N画目はどれ？」→ ストロークを選択

- 学年と難易度（★1〜3）を選んで開始
- 1セット6〜10問
- コンボシステム（連続正解でALTボーナス）
- 不正解時は正解の解説をしっかり表示（学びのフィードバック）
- リザルト画面: スコア、正答率、獲得ALT、コンボ数、間違えた問題一覧

### Phase 4: 部首パズル

- 画面にバラバラの部首パーツが表示される
- 正しい組み合わせを選んで漢字を作る
- 例: 「氵」+「毎」→「海」
- 制限時間あり（難易度で調整）
- ヒント機能（ALT消費 or 広告なしで提供）

### Phase 5: レベル＆バッジ + ALT連携

- 学習量に応じてレベルアップ（ポップアップ演出）
- バッジ条件の判定と獲得通知
- ALTの累計表示（画面右上に常時表示）
- localStorage に進捗を保存
- TRAIL Game Pro への postMessage 送信

## 重要な注意事項

- **スタンドアロン動作必須**：TRAIL Game Proがなくても単体で遊べること
- **モバイルファースト**：max-width: 480px、タッチ操作前提
- **KanjiVGクレジット**：`書き順データ: KanjiVG (CC BY-SA 3.0)` をフッターに表示
- **パフォーマンス**：初回表示3秒以内。学年JSONは遅延ロード
- **エラーハンドリング**：JSON読み込み失敗時もアプリがクラッシュしない
- **GitHub Pages対応**：相対パスで全ファイルを参照